
# MPC Controller Design for autonomous lane changing

This project contains a Model Predictive Control (MPC) implementation for autonomous vehicle lane-change maneuvers. Given a constant longitudinal velocity $v_x$, the controller computes the optimal steering angle $\delta$ to transition the vehicle from a current lane to a target lane while avoiding obstacles and ensuring passenger comfort.The controller optimizes the balance between tracking precision (reaching the target $Y$ and $\psi$) and maneuver smoothness (minimizing steering rate).

<img width="884" height="434" alt="image" src="https://github.com/user-attachments/assets/3b2ccd5b-54f7-4edd-8c86-4107650f310e" />
Fig 1: general overview of the system


<img width="1020" height="406" alt="image" src="https://github.com/user-attachments/assets/5b07ced6-0347-46d5-863f-133060d38e13" />
Fig 2: control loop

## Mathematical Model

We employ a Kinematic Bicycle Model, which is highly effective for highway speeds where lateral acceleration remains within moderate limits. 

<img width="1022" height="245" alt="image" src="https://github.com/user-attachments/assets/706ad1c1-6fc9-41be-8b1b-a6dfb4c6dfb1" />

### Reference Frames
* Global Inertial Frame ($X, Y$): The black axes (Fig. 3) representing the fixed road coordinate system.
* Vehicle Body Frame ($x, y$): The purple axes (Fig. 3) originating from the Center of Mass (CM). The $x$-axis points in the direction of the vehicle's heading, and the $y$-axis points laterally.

### Geometric Parameters
* $l_f$ and $l_r$: The distances from the CM (red dot) to the front and rear axles, respectively. These determine how the lateral forces translate into rotational torque.
* $\psi$ (Psi): The Yaw Angle, representing the vehicle's rotation relative to the global $X$-axis.
* $\delta$ (Delta): The Steering Angle of the front wheel relative to the vehicle's body. This is your MPC's control input.

### Equation of Motion
$$F_{yf} + F_{yr} = m a_y$$  

This is Newtonâ€™s Second Law ($F=ma$) applied laterally. It states that the sum of the lateral tire forces from the front ($F_{yf}$) and rear ($F_{yr}$) axles must equal the vehicle's mass ($m$) times its lateral acceleration ($a_y$).   
$a_y$ is further expanded as $\ddot{y} + v_x\dot{\psi}$, where: 
* $\ddot{y}$ is the lateral acceleration of the vehicle, assuming that the body frame is not rotating.
* $v_x\dot{\psi}$ is the centripetal acceleration.

$$F_{yf}l_f - F_{yr}l_r = I \ddot{\psi}$$  

This represents the Sum of Torques about the Center of Mass:
* $I$: The vehicle's rotational inertia (Yaw Inertia).
* $\ddot{\psi}$: The angular acceleration (Yaw acceleration).The forces at the front and rear axles "push" at different distances from the CM, causing the car to rotate into the new lane.


<img width="1061" height="805" alt="image" src="https://github.com/user-attachments/assets/52e290e7-7e0a-4981-9a57-838750010bcb" />  
Figure 3  

#### Modeling the tire

By modelling the front tire, we find out the actual forces that steer the car. And substituting the forces would further simply our equation of motion.  

The front wheel is the primary control interface. Its orientation relative to the vehicle's longitudinal axis is the steering angle $\delta$. However, because the car is moving, the actual direction the wheel travels (its velocity vector) is often slightly different from the direction it is pointing.  

##### The Slip Angle ($\alpha_f$)
The difference between the wheel's orientation and its velocity vector is the slip angle. This is a critical concept for "smooth" control. If the slip angle is too high, the car skids; if it's managed well by the MPC, the lane change feels natural.The front slip angle is modeled as: $$\alpha_f = \delta - \theta_{vf}$$ Where $\theta_{vf}$ is the angle of the velocity vector at the front wheel.

<img width="557" height="562" alt="image" src="https://github.com/user-attachments/assets/917c0c3c-8f8f-4443-a229-90100994037c" />  
Figure 4

For a smooth lane change (where lateral acceleration is typically $< 0.3g$), we use a Linear Tire Model. This assumes that the lateral force $F_{yf}$ is proportional to the slip angle.  

$$F_{yf} = C_{\alpha f} \cdot \alpha_f$$  

* $C_{\alpha f}$: The Cornering Stiffness of the front tires. This constant represents how "grippy" the tires are.
* $F_{yf}$: The lateral force generated by the front tire.

Since, we have 2 wheels in the front, the equation is rewritten as:  

$$F_{yf} = 2*C_{\alpha f} \cdot \alpha_f$$  

Similarly, for the rear wheels, the equation can be written as:  

$$F_{yr} = 2*C_{\alpha r} \cdot \alpha_r$$  

By substituting these tire models into the EOMs, we get the expanded equations:  

Lateral Force Balance:  

  $$2C_{\alpha f}(\delta - \theta_{vf}) + 2C_{\alpha r}(-\theta_{vr}) = m(\ddot{y} + \dot{x}\dot{\psi})$$  

Yaw Moment Balance:  

  $$2C_{\alpha f}(\delta - \theta_{vf})l_f - 2C_{\alpha r}(-\theta_{vr})l_r = I \ddot{\psi}$$  

We still do not the velocity vector $\theta_{vf}$ of the wheel to complete this equation and use it for our controller. So, let's derive the velocity vector. 

##### The Velocity vector ($\theta_{vf}$)

The angle of the velocity vector $\theta$ is the inverse tangent of the ratio between the lateral and longitudinal velocity components. (Fig. 5)  

<img width="585" height="313" alt="image" src="https://github.com/user-attachments/assets/8c310b2b-b6ef-490e-8616-6bcf81973bca" />  
Figure 5  

For a point at a distance $l$ from the CM along the longitudinal axis, the local lateral velocity $v_L$ is modified by the yaw rate $\dot{\psi}$:  

* At the Front Axle ($l_f$): The total lateral velocity is $\dot{y} + l_f\dot{\psi}$. (boosts the velocity of front tire while turning)  
* At the Rear Axle ($l_r$): The total lateral velocity is $\dot{y} - l_r\dot{\psi}$.  (slows down the velocity of front tire while turning)

The longitudinal velocity $\dot{x}$ is assumed constant at both axles.  

Substituting these values, we derive:  

$$\theta_{vf} = \arctan\left(\frac{\dot{y} + l_f\dot{\psi}}{\dot{x}}\right)$$  

Since, the $$\theta_{vf}$$ is very small for smooth lane changes and as it inconvenient to use inverse tan in our equation, as it makes our equation of motion non-linear, we will further simplify this equation by small angle approximation:  

$$\theta_{vf} \approx \frac{\dot{y} + l_f\dot{\psi}}{\dot{x}}$$  

Similarly, for rear wheel:  

$$\theta_{vr} = \arctan\left(\frac{\dot{y} - l_r\dot{\psi}}{\dot{x}}\right) \approx \frac{\dot{y} - l_r\dot{\psi}}{\dot{x}}$$  

Substituting this in our equation of motion, we derive:  

$$m(\ddot{y} + \dot{x}\dot{\psi}) = 2C_{\alpha f}\left(\delta - \frac{\dot{y} + l_f\dot{\psi}}{\dot{x}}\right) + 2C_{\alpha r}\left(-\frac{\dot{y} - l_r\dot{\psi}}{\dot{x}}\right)$$  

$$I\ddot{\psi} = l_f \cdot 2C_{\alpha f}\left(\delta - \frac{\dot{y} + l_f\dot{\psi}}{\dot{x}}\right) - l_r \cdot 2C_{\alpha r}\left(-\frac{\dot{y} - l_r\dot{\psi}}{\dot{x}}\right)$$  


1. Derivation for Lateral Acceleration ($\ddot{y}$)

Starting from the lateral force balance: 

$$m(\ddot{y} + \dot{x}\dot{\psi}) = 2C_{\alpha f}\left(\delta - \frac{\dot{y} + l_f\dot{\psi}}{\dot{x}}\right) + 2C_{\alpha r}\left(-\frac{\dot{y} - l_r\dot{\psi}}{\dot{x}}\right)$$  
Step 1: Expand the terms on the right-hand side:  

$$m\ddot{y} + m\dot{x}\dot{\psi} = 2C_{\alpha f}\delta - \frac{2C_{\alpha f}\dot{y}}{\dot{x}} - \frac{2C_{\alpha f}l_f\dot{\psi}}{\dot{x}} - \frac{2C_{\alpha r}\dot{y}}{\dot{x}} + \frac{2C_{\alpha r}l_r\dot{\psi}}{\dot{x}}$$  

Step 2: Group the coefficients of the state variables ($\dot{y}, \dot{\psi}$) and the input ($\delta$):  

$$m\ddot{y} = -\left(\frac{2C_{\alpha f} + 2C_{\alpha r}}{\dot{x}}\right)\dot{y} - \left(m\dot{x} + \frac{2C_{\alpha f}l_f - 2C_{\alpha r}l_r}{\dot{x}}\right)\dot{\psi} + (2C_{\alpha f})\delta$$  

Step 3: Divide by mass ($m$) to isolate $\ddot{y}$:  

$$\ddot{y} = -\left(\frac{2C_{\alpha f} + 2C_{\alpha r}}{m\dot{x}}\right)\dot{y} - \left(\dot{x} + \frac{2C_{\alpha f}l_f - 2C_{\alpha r}l_r}{m\dot{x}}\right)\dot{\psi} + \left(\frac{2C_{\alpha f}}{m}\right)\delta$$ 

2. Derivation for Yaw Acceleration ($\ddot{\psi}$)
 Starting from the yaw moment balance:

$$I\ddot{\psi} = l_f \cdot 2C_{\alpha f}\left(\delta - \frac{\dot{y} + l_f\dot{\psi}}{\dot{x}}\right) - l_r \cdot 2C_{\alpha r}\left(-\frac{\dot{y} - l_r\dot{\psi}}{\dot{x}}\right)$$  

Step 1: Expand the terms:  

$$I\ddot{\psi} = 2C_{\alpha f}l_f\delta - \frac{2C_{\alpha f}l_f\dot{y}}{\dot{x}} - \frac{2C_{\alpha f}l_f^2\dot{\psi}}{\dot{x}} + \frac{2C_{\alpha r}l_r\dot{y}}{\dot{x}} - \frac{2C_{\alpha r}l_r^2\dot{\psi}}{\dot{x}}$$  

Step 2: Group the coefficients:  

$$I\ddot{\psi} = -\left(\frac{2C_{\alpha f}l_f - 2C_{\alpha r}l_r}{\dot{x}}\right)\dot{y} - \left(\frac{2C_{\alpha f}l_f^2 + 2C_{\alpha r}l_r^2}{\dot{x}}\right)\dot{\psi} + (2C_{\alpha f}l_f)\delta$$  

Step 3: Divide by inertia ($I$) to isolate $\ddot{\psi}$:  

$$\ddot{\psi} = -\left(\frac{2C_{\alpha f}l_f - 2C_{\alpha r}l_r}{I\dot{x}}\right)\dot{y} - \left(\frac{2C_{\alpha f}l_f^2 + 2C_{\alpha r}l_r^2}{I\dot{x}}\right)\dot{\psi} + \left(\frac{2C_{\alpha f}l_f}{I}\right)\delta$$  

## State Space Equations














